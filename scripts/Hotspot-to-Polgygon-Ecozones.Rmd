---
title: "Hotspot point data to polygon"
author: "Anna Talucci"
date: "2/6/2020"
output: html_document
---

# Overview
Convert Hotspot point data from MODIS to polygons. The purpose of this is to limit the extent of the vector function in GEE to delinieate fire perimeters.


Data acquired from [FIRMS](https://firms.modaps.eosdis.nasa.gov/download/create.php)

Description of [Modis and VIIRS data](https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms)

VIIRS launch October 2012, fire season data available 2012-present
MODIS launch    , available 2001-present

Take all annual hotspot data and make polygons 2001-2020. We did not end up combine MODIS/VIIRS data from 2012-2020, because the data set became to large.
 
What is included in this script:

Note:
Because these data sets area large spatial data sets, we will set this up to run annual data across each bounding box.

# Clear workspace

```{r}
rm(list=ls()) 
```

# Packages

```{r include=FALSE}
library(sp)
library(sf)
library(rgdal) # geospatial data
library(raster)
library(rgeos) # GIS Geometry
library(foreign) # deals with dbf files
library(dplyr)
library(spatialEco)
library(lubridate)
library(nngeo)
```

# Projections

WGS 84 need for gee
```{r}
wgs_proj =  "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "
```

[Equal Area projection for Russia](https://gis.stackexchange.com/questions/264093/projection-for-russia-map) is needed for buffering hotspot data.

The projection:
+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs 

```{r}
ee_russia = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "
```

# Data

## Hotspot Data (MODIS)**(change year on data and saving at end)**
```{r}
hs = readOGR("../data/M6-march-october/M6_mar-oct_2003.shp", "M6_mar-oct_2003") 
```

### project to equal area russia
```{r}
hs_ee = spTransform(hs, CRS(ee_russia))
```

## Chukchi

```{r}
ch_west = st_read("../data/ecozones/chukchi_east_west/cpt_bt_west.shp", "cpt_bt_west") 
```

```{r}
ch_east = st_read("../data/ecozones/chukchi_east_west/cpt_bt_east.shp", "cpt_bt_east") 
```

### Equal Area
```{r}
ch_west_ee = st_transform(ch_west, crs=ee_russia)
ch_east_ee = st_transform(ch_east, crs=ee_russia)
```

# 2003 Data issue

One of the hotspots sits on the 180/-180 longitude. This  locaton causes an issue once the polygons have been created and convered back to WGS  84 projection.

```{r}
hs_ee_sf = st_as_sf(hs_ee)
```

```{r}
issue_pt = hs_ee_sf %>% filter(LONGITUDE > 179)
issue_pt
```
```{r}
remove_issue_pt = hs_ee_sf %>% filter(LONGITUDE != 179.9466)
```

```{r}
plot(ch_west_ee$geometry);
plot(remove_issue_pt, add=TRUE, col='red')
```

```{r}
plot(ch_west_ee$geometry);
plot(hs_ee_sf, add=TRUE, col='red');
plot(issue_pt, add=TRUE, col='blue');
```
```{r}
eco_ee = st_read("../data/ecozones/eco_SinglePoly_ee.shp", "eco_SinglePoly_ee") 
```
## 2003 pt to poly
```{r eval=FALSE, include=FALSE}
eco_hs = hs_ee_sf[eco_ee, ]

remove_issue_pt = eco_hs %>% filter(LONGITUDE != 179.9466)

eco_hs_3k = st_buffer(remove_issue_pt, dist = 3000, endCapStyle = "ROUND",
joinStyle = "ROUND",) # Buffer by 3k

eco_hs_3k_nh = nngeo::st_remove_holes(eco_hs_3k)

eco_hs_3k_nh_wgs = st_transform(eco_hs_3k_nh, crs=wgs_proj)
```

```{r eval=FALSE, include=FALSE}
st_write(eco_hs_3k_nh_wgs, "../outputs/hotspot-poly-single-eco/hspoly_singleEco_2003.shp", driver="ESRI Shapefile")
```


# Process point to polygon
This code uses a single polygon that covers all nine ecozones

1. Select points within ecozone region
2. Buffer points by 3000 m overlapping polygons join
3. Remove any holes in the polygons
4. Convert back to WGS 84
5. Conver to sf object
6. Write to shapefile

## For Single Poly
All years except 2019 & 2020

### Single  Ecozone Bounds
All ecozones have been combined into a single polygon

```{r}
eco_ee = readOGR("../data/ecozones/eco_SinglePoly_ee.shp", "eco_SinglePoly_ee") 
```

```{r}
eco_hs = hs_ee[eco_ee, ]
eco_hs_3k = gBuffer(eco_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
eco_hs_3k_nh = remove.holes(eco_hs_3k) # Remove holes in polygons
eco_hs_wgs = spTransform(eco_hs_3k_nh, CRS( wgs_proj)) # reproject to WGS for GEE
eco_hs_wgs_sf = st_as_sf(eco_hs_wgs)
```

```{r eval=FALSE, include=FALSE}
st_write(eco_hs_wgs_sf, "../outputs/hotspot-poly-single-eco/hspoly_singleEco_2003.shp", driver="ESRI Shapefile")
```

## For Large data year (2003, 2019 & 2020)
Split the region of interest (ROI; single polygon) into 3 ROIs.  Process the point to polygon on the 3 ROIs and then combine into single shapefile.

### For NE Poly 1
```{r}
eco_nepoly1_ee = readOGR("../data/ecozones/eco_NEPoly1_ee.shp", "eco_NEPoly1_ee") 
```

```{r}
eco1_hs = hs_ee[eco_nepoly1_ee, ]
eco1_hs_3k = gBuffer(eco1_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
eco1_hs_3k_nh = remove.holes(eco1_hs_3k) # Remove holes in polygons
eco1_hs_wgs = spTransform(eco1_hs_3k_nh, CRS( wgs_proj)) # reproject to WGS for GEE
eco1_hs_wgs_sf = st_as_sf(eco1_hs_wgs)
```

```{r eval=FALSE, include=FALSE}
st_write(eco1_hs_wgs_sf, "../outputs/hotspot-poly-single-eco/hspoly_NE_Eco_2020.shp", driver="ESRI Shapefile")
```




### For eastern portion of E Poly 2
```{r}
eco_E_EPoly2_1_ee = readOGR("../data/ecozones/eco_E_EPoly2_1_ee.shp", "eco_E_EPoly2_1_ee") 
```

```{r}
eco2_hs = hs_ee[eco_E_EPoly2_1_ee, ]
eco2_hs_3k = gBuffer(eco2_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
eco2_hs_3k_nh = remove.holes(eco2_hs_3k) # Remove holes in polygons
eco2_hs_wgs = spTransform(eco2_hs_3k_nh, CRS( wgs_proj)) # reproject to WGS for GEE
eco2_hs_wgs_sf = st_as_sf(eco2_hs_wgs)
```

```{r eval=FALSE, include=FALSE}
eco2_hs_3k_nh_sf = st_as_sf(eco2_hs_3k_nh)
st_write(eco3_hs_3k_nh_sf, "../outputs/test/eco2_hs_3k_nh_ee_2003.shp", driver="ESRI Shapefile")
```

```{r eval=FALSE, include=FALSE}
st_write(eco2_hs_wgs_sf, "../outputs/hotspot-poly-single-eco/hspoly_EEPOLY_Eco_2020.shp", driver="ESRI Shapefile")
```

### For western portion of E Poly 2
```{r}
eco_W_EPoly2_2_ee =  readOGR("../data/ecozones/eco_W_EPoly2_2_ee.shp", "eco_W_EPoly2_2_ee") 
```

```{r}
eco3_hs = hs_ee[eco_W_EPoly2_2_ee, ]
eco3_hs_3k = gBuffer(eco3_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
eco3_hs_3k_nh = remove.holes(eco3_hs_3k) # Remove holes in polygons
eco3_hs_wgs = spTransform(eco3_hs_3k_nh, CRS( wgs_proj)) # reproject to WGS for GEE
eco3_hs_wgs_sf = st_as_sf(eco3_hs_wgs)
```

```{r eval=FALSE, include=FALSE}
eco3_hs_3k_nh_sf = st_as_sf(eco3_hs_3k_nh)
st_write(eco3_hs_3k_nh_sf, "../outputs/test/eco3_hs_3k_nh_ee_2003.shp", driver="ESRI Shapefile")
```

```{r eval=FALSE, include=FALSE}
st_write(eco3_hs_wgs_sf, "../outputs/hotspot-poly-single-eco/hspoly_WEPoly_Eco_2020.shp", driver="ESRI Shapefile")
```

# Combine Hotspot poly into one file for 2019 & 2020
1. Convert to sf object
2. `rbind` to combine into single file
3. Union to merge overlaping polygons
4. Cast as individual polygons
5. remove any holes that occur from processing
```{r}
eco1_sf = st_as_sf(eco1_hs_3k_nh)
eco2_sf = st_as_sf(eco2_hs_3k_nh)
eco3_sf = st_as_sf(eco3_hs_3k_nh) 

merge_polys = rbind(eco1_sf, eco2_sf, eco3_sf)

merge_polys_un = sf::st_union(merge_polys)

merge_polys_un_poly = sf::st_cast(merge_polys_un, "POLYGON")

merge_polys_un_poly_nh = nngeo::st_remove_holes(merge_polys_un_poly)
```

```{r}
plot(merge_polys_un_poly_nh)
```
```{r}
merge_polys_un_poly_nh_wgs = st_transform(merge_polys_un_poly_nh, wgs_proj) # reproject to WGS for GEE

st_write(merge_polys_un_poly_nh_wgs, "../outputs/hotspot-poly-single-eco/hspoly_singleEco_2019.shp", driver="ESRI Shapefile")
```


#  *******RUN ALL ABOVE8*******************


# ***********DELETE ALL BELOW****************
## Visualize points
### CKMT_NSCT
```{r}
ckmt_nst_nsct_hs = hs_ee[ckmt_nst_nsct_ee, ]
plot(ckmt_nst_nsct_hs)
plot(ckmt_nst_nsct_ee, add=TRUE)
```

## TCST_N
```{r}
tcst_n_hs = hs_ee[tcst_n_ee, ]
plot(tcst_n_hs)
```


## TCST_S
```{r}
tcst_s_hs = hs_ee[tcst_s_ee, ]
plot(tcst_s_hs)
```

## EST_TBBMT_N
```{r}
est_tbbmt_n_hs = hs_ee[est_tbbmt_n_ee, ]
plot(est_tbbmt_n_hs)
```


### CHECK OVERLAP
plot(st_geometry(ecozones_ee), border = 'grey', 
     axes = TRUE)
plot(st_geometry(st_centroid(fires_at_eco_arc_hs_merge)), pch = 3, col = 'red', add = TRUE)
```{r}
plot(est_tbbmt_n_ee, border = 'grey')
plot(tcst_s_ee, add = TRUE)
plot(est_tbbmt_n_hs, col = 'grey', add = TRUE)
plot(tcst_s_hs, add = TRUE)

```


## EST_TBBMT_S
```{r}
est_tbbmt_s_hs = hs_ee[est_tbbmt_s_ee, ]
plot(est_tbbmt_s_hs)
```
## CPT_BT_EAST
```{r}
cpt_bt_east_hs = hs_ee[cpt_bt_east_ee, ]
plot(cpt_bt_east_hs)
```

## CPT_BT_WEST
```{r}
cpt_bt_west_hs = hs_ee[cpt_bt_west_ee, ]
plot(cpt_bt_west_hs)
```

# Process by separate ecozones bounding boxes

## CKMT_NSCT

```{r}
ckmt_nst_nsct_hs_3k = gBuffer(ckmt_nst_nsct_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
ckmt_nst_nsct_hs_3k_nh = remove.holes(ckmt_nst_nsct_hs_3k) # Remove holes in polygons
ckmt_nst_nsct_hs_wgs = spTransform(ckmt_nst_nsct_hs_3k_nh, CRS( wgs_proj)) # reproject to WGS for GEE
ckmt_nst_nsct_hs_wgs_sf = st_as_sf(ckmt_nst_nsct_hs_wgs)
```

```{r}
st_write(ckmt_nst_nsct_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_ckmt_nst_nsct_2001.shp", driver="ESRI Shapefile")
```

```{r}
plot(ckmt_nst_nsct, border = 'grey')
plot(ckmt_nst_nsct_hs_wgs_sf, col = 'grey', add = TRUE)
```

## TCST_N

```{r}
tcst_n_hs_3k = gBuffer(tcst_n_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")# Buffer by 3k
tcst_n_hs_3k_nh = remove.holes(tcst_n_hs_3k)# Remove holes in polygons
tcst_n_hs_wgs = spTransform(tcst_n_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
tcst_n_hs_wgs_sf = st_as_sf(tcst_n_hs_wgs) # Sp to sf
st_write(tcst_n_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_tcst_n_2001.shp", driver="ESRI Shapefile")# Write to file
```

## TCST_S
```{r}
tcst_s_hs_3k = gBuffer(tcst_s_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
tcst_s_hs_3k_nh = remove.holes(tcst_s_hs_3k)# Remove holes in polygons
tcst_s_hs_wgs = spTransform(tcst_s_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
tcst_s_hs_wgs_sf = st_as_sf(tcst_s_hs_wgs) # Sp to sf
```


```{r}
st_write(tcst_s_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_tcst_s_2001.shp", driver="ESRI Shapefile")# Write to file
```


## EST_TBBMT_N

```{r}
est_tbbmt_n_hs_3k = gBuffer(est_tbbmt_n_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
est_tbbmt_n_hs_3k_nh = remove.holes(est_tbbmt_n_hs_3k)# Remove holes in polygons
est_tbbmt_n_hs_wgs = spTransform(est_tbbmt_n_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
est_tbbmt_n_hs_wgs_sf = st_as_sf(est_tbbmt_n_hs_wgs) # Sp to sf
```

```{r}
st_write(est_tbbmt_n_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_est_tbbmt_n_2001.shp", driver="ESRI Shapefile")# Write to file
```

### CHECK OVERLAP
```{r}
plot(est_tbbmt_n, border = 'grey')
plot(tcst_s, add = TRUE)
plot(est_tbbmt_n_hs_wgs_sf, col = 'grey', add = TRUE)
plot(tcst_s_hs_wgs_sf, add = TRUE)

```
```{r}
plot(est_tbbmt_n, border = 'grey')
plot(est_tbbmt_n_hs_wgs_sf, col = 'grey', add = TRUE)
```

```{r}
plot(tcst_s)

plot(tcst_s_hs_wgs_sf, add = TRUE)

```
## EST_TBBMT_S

```{r}
est_tbbmt_s_hs_3k = gBuffer(est_tbbmt_s_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
est_tbbmt_s_hs_3k_nh = remove.holes(est_tbbmt_s_hs_3k)# Remove holes in polygons
est_tbbmt_s_hs_wgs = spTransform(est_tbbmt_s_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
est_tbbmt_s_hs_wgs_sf = st_as_sf(est_tbbmt_s_hs_wgs) # Sp to sf
st_write(est_tbbmt_s_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_est_tbbmt_s_2001.shp", driver="ESRI Shapefile")# Write to file
```
## CPT_BT_EAST

```{r}
cpt_bt_east_hs_3k = gBuffer(cpt_bt_east_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
cpt_bt_east_hs_3k_nh = remove.holes(cpt_bt_east_hs_3k)# Remove holes in polygons
cpt_bt_east_hs_wgs = spTransform(cpt_bt_east_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
cpt_bt_east_hs_wgs_sf = st_as_sf(cpt_bt_east_hs_wgs) # Sp to sf
st_write(cpt_bt_east_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_cpt_bt_east_2001.shp", driver="ESRI Shapefile")# Write to file

```


## CPT_BT_WEST

```{r}
cpt_bt_west_hs_3k = gBuffer(cpt_bt_west_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND") # Buffer by 3k
cpt_bt_west_hs_3k_nh = remove.holes(cpt_bt_west_hs_3k)# Remove holes in polygons
cpt_bt_west_hs_wgs = spTransform(cpt_bt_west_hs_3k_nh, CRS( wgs_proj))# reproject to WGS for GEE
cpt_bt_west_hs_wgs_sf = st_as_sf(cpt_bt_west_hs_wgs) # Sp to sf
st_write(cpt_bt_west_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_cpt_bt_west_2001.shp", driver="ESRI Shapefile")# Write to file
```














