---
title: "Hotspot point data to polygon"
author: "Anna Talucci"
date: "2/6/2020"
output: html_document
---

# Overview
Convert Hotspot/VIIRS point data to polygons. This is to limit the extent of the vector function in GEE to delinieate fire perimeters.


Data acquired from [FIRMS](https://firms.modaps.eosdis.nasa.gov/download/create.php)

Description of [Modis and VIIRS data](https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms)

VIIRS launch October 2011, fire season data available 2012-present
MODIS launch    , available 2001-present

Take all annual hotspot data and make polygons 2001-2020, where 2012-2020 is the combine MODIS/VIIRS Data
 
What is included in this script:

Note:
Because these data sets area large spatial data sets, we will set this up to run annual data across each bounding box.
# Clear workspace

```{r}
rm(list=ls()) 
```
# Packages

```{r include=FALSE}
library(sp)
library(sf)
library(rgdal) # geospatial data
library(raster)
library(rgeos) # GIS Geometry
library(foreign) # deals with dbf files
library(dplyr)
library(spatialEco)
library(lubridate)
```

# Projections

WGS 84 need for gee
```{r}
wgs_proj =  "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "

```

Equal Area projection for russia need for buffering hotspot data
https://gis.stackexchange.com/questions/264093/projection-for-russia-map

+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs 

```{r}
ee_russia = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "
```

# Bounding Box Ecozones
## Data
```{r}

ckmt_nst_nsct = readOGR("../data/bbox/ecozone_bbox/ckmt_nst_nsct.shp", "ckmt_nst_nsct")
tcst_n = readOGR("../data/bbox/ecozone_bbox/tcst_n.shp", "tcst_n")
tcst_s = readOGR("../data/bbox/ecozone_bbox/tcst_s.shp", "tcst_s")
est_tbbmt_n = readOGR("../data/bbox/ecozone_bbox/est_tbbmt_n.shp", "est_tbbmt_n")
est_tbbmt_s = readOGR("../data/bbox/ecozone_bbox/est_tbbmt_s.shp", "est_tbbmt_s")
cpt_bt_west = readOGR("../data/bbox/ecozone_bbox/cpt_bt_west.shp", "cpt_bt_west")
cpt_bt_east = readOGR("../data/bbox/ecozone_bbox/cpt_bt_east.shp", "cpt_bt_east")

```

## Covert to Equal Area
```{r}
ckmt_nst_nsct_ee = spTransform(ckmt_nst_nsct, CRS(ee_russia))
tcst_n_ee = spTransform(tcst_n, CRS(ee_russia))
tcst_s_ee = spTransform(tcst_s, CRS(ee_russia))
est_tbbmt_n_ee = spTransform(est_tbbmt_n, CRS(ee_russia))
est_tbbmt_s_ee = spTransform(est_tbbmt_s, CRS(ee_russia))
cpt_bt_west_ee = spTransform(cpt_bt_west, CRS(ee_russia))
cpt_bt_east_ee = spTransform(cpt_bt_east, CRS(ee_russia))
```

# Hotspot Data (MODIS and VIIRS)

## Read in data **(change year on data and saving at end)**

```{r}
hs = readOGR("../data/hotspot-march-october/hotspot_mar-oct_2002.shp", "hotspot_mar-oct_2002") 
```

# Process dataset

## project to equal area russia
```{r}
hs_ee = spTransform(hs, CRS(ee_russia))
```

## Subset area to BBOX ecozone
```{r}
ckmt_nst_nsct_hs = hs_ee[ckmt_nst_nsct_ee, ]
tcst_n_hs = hs_ee[tcst_n_ee, ]
tcst_s_hs = hs_ee[tcst_s_ee, ]
est_tbbmt_n_hs = hs_ee[est_tbbmt_n_ee, ]
est_tbbmt_s_hs = hs_ee[est_tbbmt_s_ee, ]
cpt_bt_west_hs = hs_ee[cpt_bt_west_ee, ]
cpt_bt_east_hs = hs_ee[cpt_bt_east_ee, ]
```

### Buffer by 3k

```{r}
ckmt_nst_nsct_hs_3k = gBuffer(ckmt_nst_nsct_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
tcst_n_hs_3k = gBuffer(tcst_n_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
tcst_s_hs_3k = gBuffer(tcst_s_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
est_tbbmt_n_hs_3k = gBuffer(est_tbbmt_n_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
est_tbbmt_s_hs_3k = gBuffer(est_tbbmt_s_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
cpt_bt_west_hs_3k = gBuffer(cpt_bt_west_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")
cpt_bt_east_hs_3k = gBuffer(cpt_bt_east_hs, width = 3000, capStyle="ROUND", joinStyle="ROUND")

```

### Remove holes in polygons
```{r}
ckmt_nst_nsct_hs_3k_nh = remove.holes(ckmt_nst_nsct_hs_3k)
tcst_n_hs_3k_nh = remove.holes(tcst_n_hs_3k)
tcst_s_hs_3k_nh = remove.holes(tcst_s_hs_3k)
est_tbbmt_n_hs_3k_nh = remove.holes(est_tbbmt_n_hs_3k)
est_tbbmt_s_hs_3k_nh = remove.holes(est_tbbmt_s_hs_3k)
cpt_bt_west_hs_3k_nh = remove.holes(cpt_bt_west_hs_3k)
cpt_bt_east_hs_3k_nh = remove.holes(cpt_bt_east_hs_3k)
```

### reproject to WGS for GEE
```{r}
ckmt_nst_nsct_hs_wgs = spTransform(ckmt_nst_nsct_hs_3k_nh, CRS( wgs_proj))
tcst_n_hs_wgs = spTransform(tcst_n_hs_3k_nh, CRS( wgs_proj))
tcst_s_hs_wgs = spTransform(tcst_s_hs_3k_nh, CRS( wgs_proj))
est_tbbmt_n_hs_wgs = spTransform(est_tbbmt_n_hs_3k_nh, CRS( wgs_proj))
est_tbbmt_s_hs_wgs = spTransform(est_tbbmt_s_hs_3k_nh, CRS( wgs_proj))
cpt_bt_west_hs_wgs = spTransform(cpt_bt_west_hs_3k_nh, CRS( wgs_proj))
cpt_bt_east_hs_wgs = spTransform(cpt_bt_east_hs_3k_nh, CRS( wgs_proj))

```


### Sp to sf

```{r}
ckmt_nst_nsct_hs_wgs_sf = st_as_sf(ckmt_nst_nsct_hs_wgs)
tcst_n_hs_wgs_sf = st_as_sf(tcst_n_hs_wgs)
tcst_s_hs_wgs_sf = st_as_sf(tcst_s_hs_wgs)
est_tbbmt_n_hs_wgs_sf = st_as_sf(est_tbbmt_n_hs_wgs)
est_tbbmt_s_hs_wgs_sf = st_as_sf(est_tbbmt_s_hs_wgs)
cpt_bt_west_hs_wgs_sf = st_as_sf(cpt_bt_west_hs_wgs)
cpt_bt_east_hs_wgs_sf = st_as_sf(cpt_bt_east_hs_wgs)
```

### Write to file
Create a shapefile

```{r eval=FALSE, include=FALSE}
st_write(ckmt_nst_nsct_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_ckmt_nst_nsct_2002.shp", driver="ESRI Shapefile")
st_write(tcst_n_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_tcst_n_2002.shp", driver="ESRI Shapefile")
st_write(tcst_s_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_tcst_s_2002.shp", driver="ESRI Shapefile")
st_write(est_tbbmt_n_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_est_tbbmt_n_2002.shp", driver="ESRI Shapefile")
st_write(est_tbbmt_s_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_est_tbbmt_s_2002.shp", driver="ESRI Shapefile")
st_write(cpt_bt_west_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_cpt_bt_west_2002.shp", driver="ESRI Shapefile")
st_write(cpt_bt_east_hs_wgs_sf, "../outputs/hotspot-poly-ecozone/hspoly_cpt_bt_east_2002.shp", driver="ESRI Shapefile")
```










