---
title: "Clean Polygon data"
author: "Anna Talucci"
date: "3/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Using part2-gee-vectors-SingleEco data file, we remove holes, convert from multipoly to polygon, apply negative buffer, and combine into single shapefile.

In GEE, vectors were run within  hotspot polygons that spanned all 9 ecozones, but run on 7 separate composit images.

1. ckmt_nst_nsct_flare_fires_YEAR
2. cpt_bt_east_flare_fires_YEAR
3. cpt_bt_west_flare_fires_YEAR
4. est_tbbmt_n_flare_fires_YEAR
5. est_tbbmt_s_flare_fires_YEAR
6. tcst_n_flare_fires_YEAR
7. tcst_s_flare_fires_YEAR


What is included in this script:

# Packages

```{r include=FALSE}
library(sp)
library(sf)
library(rgdal) # geospatial data
library(raster)
library(rgeos) # GIS Geometry
library(foreign) # deals with dbf files
library(dplyr)
library(tidyr)
library(spatialEco)
library(ggplot2)
library(nngeo)
```

# Projections

WGS 84 need for gee
```{r}
wgs_proj =  "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "
```

Equal Area projection for russia need for buffering hotspot data
https://gis.stackexchange.com/questions/264093/projection-for-russia-map

+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs 

```{r}
ee_russia = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "
```

# Read in shapefile
ckmt_nst_nsct_flare_fires2001
cpt_bt_east_flare_fires_2001
cpt_bt_west_flare_fires_2001
est_tbbmt_n_flare_fires_2001
est_tbbmt_s_flare_fires_2001
tcst_n_flare_fires_2001
tcst_s_flare_fires_2001
```{r}
ckmt_nst_nsct = st_read("../data/part2-gee-vectors-SingleEco/ckmt_nst_nsct_fires_2001.shp", "ckmt_nst_nsct_fires_2001") 
cpt_bt_east = st_read("../data/part2-gee-vectors-SingleEco/cpt_bt_east_fires_2001.shp", "cpt_bt_east_fires_2001") 
cpt_bt_west = st_read("../data/part2-gee-vectors-SingleEco/cpt_bt_west_fires_2001.shp", "cpt_bt_west_fires_2001") 
est_tbbmt_n = st_read("../data/part2-gee-vectors-SingleEco/est_tbbmt_n_fires_2001.shp", "est_tbbmt_n_fires_2001") 
est_tbbmt_s = st_read("../data/part2-gee-vectors-SingleEco/est_tbbmt_s_fires_2001.shp", "est_tbbmt_s_fires_2001") 
tcst_n = st_read("../data/part2-gee-vectors-SingleEco/tcst_n_fires_2001.shp", "tcst_n_fires_2001") 
tcst_s = st_read("../data/part2-gee-vectors-SingleEco/tcst_s_fires_2001.shp", "tcst_s_fires_2001") 
```

# Equal Area
```{r}
ckmt_nst_nsct_ee = st_transform(ckmt_nst_nsct, crs=ee_russia)
cpt_bt_east_ee = st_transform(cpt_bt_east, crs=ee_russia)
cpt_bt_west_ee = st_transform(cpt_bt_west, crs=ee_russia)
est_tbbmt_n_ee = st_transform(est_tbbmt_n, crs=ee_russia)
est_tbbmt_s_ee = st_transform(est_tbbmt_s, crs=ee_russia)
tcst_n_ee = st_transform(tcst_n, crs=ee_russia)
tcst_s_ee = st_transform(tcst_s, crs=ee_russia)
```

# Combine into one shapefile
```{r}
all_shp = rbind(ckmt_nst_nsct_ee, cpt_bt_east_ee, cpt_bt_west_ee, est_tbbmt_n_ee, est_tbbmt_s_ee, tcst_n_ee, tcst_s_ee)
```

```{r}
plot(all_shp$geometry)
```


## Clean Polgygons

1. Union is use to merge overlaping polygons 
  + For example, where a fire spans the imagery boundaries producing multiple polygons, these are merged into a single polygon.
2. Cast to Polygon
  + This convers from a multipolygon to individual Polygons
3. Remove Holes
  + This removes any holes created in polgyons during the GEE vectorize process, or when mergeing polygons
  + It is important to remove as holes can cause issues during geoprocesses.
4. **Vectors have too many edges to use in GEE after processing - Need to integrate a smoothing function.**
- 
```{r}
all_shp_un = sf::st_union(all_shp)

all_shp_un_poly = sf::st_cast(all_shp_un, "POLYGON")
```


```{r}
all_shp_un_poly_nh = nngeo::st_remove_holes(all_shp_un_poly)
```

```{r eval=FALSE, include=FALSE}
st_write(all_shp_un_poly, "../outputs/GEE-clean-shapefiles-SingleEco/combine_ecozones_2001.shp", driver="ESRI Shapefile") 
```


