---
title: "Fire Activity Data Organization"
author: "Anna Talucci"
date: "10/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Assembly fire perimeter shape files with attribute data from hotspot data and bioclimatic zones, and climate. Data  needs to include:
- Fire year
- Fire class size
- Fire start date (julian annual)
- Fire end date (julian annual)
- Bioclimatic zone (ecozone)
- Max temp
- Drought index
- Snow off date




# Library

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)
library(cowplot)
library(ggcorrplot)
library(sp)
library(sf)
library(rgdal) # geospatial data
library(raster)
library(rgeos) # GIS Geometry
library(foreign) # deals with dbf files
library(lubridate)
```

# Read in Data  (Automated)
Read in multiple data files
f01 = st_read("../data/clean-shapefile/flare_30m/fires2001.shp", "fires2001") 
```{r}
fire_path <- "../data/clean-shapefile/flare_30m"   # path to the data
fire_files <- list.files(fire_path, pattern = "\\.shp$") %>% setNames(nm = .) # get file names
fire_files
```
```{r}
st_read(fire_files)
```

```{r}
head(fire2002)
```

 replace with your folder name:
dir <- "c:/files/shpfiles"
ff <- list.files(dir, pattern="\\.shp$", full.names=TRUE)



```{r eval=FALSE, include=FALSE}
month_data <- month_files %>%
  # read in all the files, appending the path before the filename
  map(~ read_csv(file.path(month_path, .), .id = "file_name")) %>% 
  reduce(rbind)
month_data
```
map_df(~read_csv(.x, col_types = cols(), col_names = FALSE), .id = "file_name")


```{r eval=FALSE, include=FALSE}
list_of_files <- list.files(path = "../data/climate_monthly",
                            full.names = TRUE)
list_of_files
df <- list_of_files %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x, col_types = cols(), col_names = TRUE), .id = "file_name")     
df
```
 separate(file_name, c("A","B","C"), sep = "([.?:])")
```{r eval=FALSE, include=FALSE}
df1 = df %>% 
  separate(file_name, c("A","B","C","D","E","F","G"), sep = "([..///_])", extra = "merge") %>%
  separate(G, c("A1","B1","C1","D1","E1","F1","G1"), sep = "([._])", extra = "merge") %>%
  dplyr::select(A1:B1, ID_obj:vs) %>%
  rename(climate_yr = A1, climate_mon = B1)

df1
  
```

# Read in one fire year are test extracting attributes
```{r}
fire2001 = st_read("../data/clean-shapefile/flare_30m/fires2001.shp", "fires2001")
fire2002 = st_read("../data/clean-shapefile/flare_30m/fires2002.shp", "fires2002")
```

```{r}
hotspot2001 = st_read("../data/hotspot_data/DL_FIRE_M6_2001/fire_archive_2001.shp", "fire_archive_2001") 
hotspot2002 = st_read("../data/hotspot_data/DL_FIRE_M6_2002/fire_archive_2002.shp", "fire_archive_2002") 
```

```{r}
head(hotspot)
```

```{r}
head(perimeter)  # polygons
head(hotspot) # points
plot(perimeter)
plot(hotspot, add=TRUE)
```
##
```{r}
test = st_intersection(hotspot, perimeter)
```

```{r}
summary(test)
```
```{r}
str(test$ACQ_DATE)
```
```{r}
test1 = test %>% mutate(julian_date = yday(ACQ_DATE))
head(test1)
```



```{r}
test_sum = test1 %>% separate(ACQ_DATE, c("acq_year","acq_month", "acq_day"), sep = "-", remove=FALSE) %>% group_by(ID_obj) %>% 
  summarize(min_julian_date = min(julian_date),
            max_julian_date = max(julian_date),
            mean_julian_date = mean(julian_date),
            median_julian_date = median(julian_date),
            min_acq_month = min(acq_month),
            min_acq_day = min(acq_day), 
            max_acq_month = max(acq_month),
            max_acq_day = max(acq_day), 
            min_confidence = min(CONFIDENCE), 
            max_confidence = max(CONFIDENCE), 
            mean_confidence = mean(CONFIDENCE), 
            median_confidence = median(CONFIDENCE)) 
```
## Parrt 1: Overlay
Overlay hotspot and  fire perimeter data by year in order to add attributes from hotspots to fire perimeters  that they interect. This will add attributes for:
- Fire start
- Fire end
- Accuracy


### Functions
Function for overlay and itentifying in
```{r}
f_intersect = function(point,polygon) {
  df_int = st_intersection(point, polygon)
  
  return(df_int)
}
```


This function summarizes the point data (i.e., hotspot data) per polygon (i.e., fire perimeters)
```{r}
f1 = function(x){
  x %>% mutate(julian_date = yday(ACQ_DATE)) %>%
  separate(ACQ_DATE, c("acq_year","acq_month", "acq_day"), sep = "-", remove=FALSE) %>% group_by(ID_obj) %>% 
  summarize(min_julian_date = min(julian_date),
            max_julian_date = max(julian_date),
            mean_julian_date = mean(julian_date),
            median_julian_date = median(julian_date),
            min_acq_month = min(acq_month),
            min_acq_day = min(acq_day), 
            max_acq_month = max(acq_month),
            max_acq_day = max(acq_day), 
            min_confidence = min(CONFIDENCE), 
            max_confidence = max(CONFIDENCE), 
            mean_confidence = mean(CONFIDENCE), 
            median_confidence = median(CONFIDENCE)) -> x
  return(x)
}
```

### Apply  functions 

```{r}
f_intersect(hotspot2001, fire2001) %>% f1()
```

# Trying to Automate

```{r}
polygon1 = list(fire2001, fire2002)
point1 = list(hotspot2001, hotspot2002)
```



Overlay points and polygons to determine intersection
```{r}
test = st_intersection(hotspot, perimeter)
```



```{r}
test_i = f_intersect(hotspot2001, fire2001)
```

```{r}
test_intersect1 = f_intersect(point1,polygon1)
```

## Functions
Function for overlay and itentifying in
```{r}
f_intersect = function(point,polygon) {
  df_int = st_intersection(point, polygon)
  
  return(df_int)
}
```


This function summarizes the point data (i.e., hotspot data) per polygon (i.e., fire perimeters)
```{r}
f1 = function(x){
  x %>% mutate(julian_date = yday(ACQ_DATE)) %>%
  separate(ACQ_DATE, c("acq_year","acq_month", "acq_day"), sep = "-", remove=FALSE) %>% group_by(ID_obj) %>% 
  summarize(min_julian_date = min(julian_date),
            max_julian_date = max(julian_date),
            mean_julian_date = mean(julian_date),
            median_julian_date = median(julian_date),
            min_acq_month = min(acq_month),
            min_acq_day = min(acq_day), 
            max_acq_month = max(acq_month),
            max_acq_day = max(acq_day), 
            min_confidence = min(CONFIDENCE), 
            max_confidence = max(CONFIDENCE), 
            mean_confidence = mean(CONFIDENCE), 
            median_confidence = median(CONFIDENCE)) -> x
  return(x)
}
```

```{r}
f_intersect(hotspot2001, fire2001) %>% f1()
```

```{r}
f1(test_i)
```
```{r}
f1(test)
```


```{r}
f1(test_intersect)
```

```{r}
test_sum
```

```{r}
st_geometry(test_sum) <- NULL
```

```{r}
head(test_sum)
```
```{r}
merge(perimeter, test_sum, by="ID_obj")
```

