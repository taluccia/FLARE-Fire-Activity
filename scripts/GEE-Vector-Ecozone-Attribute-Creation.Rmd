---
title: "GEE Vector Ecozone Attribute Creation"
author: "Anna Talucci"
date: "3/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Here we take the cleaned vectors of fire perimeters and add attributes, clip to ecozone extent, add ecozone attributes, designate as arctic or sub arctic, and add attributes from hotspot data (e.g., fire start).

# Packages

```{r include=FALSE}
library(sp)
library(sf)
library(rgdal) # geospatial data
library(raster)
library(rgeos) # GIS Geometry
library(foreign) # deals with dbf files
library(dplyr)
library(tidyr)
library(spatialEco)
library(ggplot2)
library(lubridate)
```

# Projections

WGS 84 need for gee
```{r}
wgs_proj =  "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "
```

Equal Area projection for russia need for buffering hotspot data
https://gis.stackexchange.com/questions/264093/projection-for-russia-map

+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs 

```{r}
ee_russia = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "
```


# Data

## Fire perimeters

```{r}
fires = st_read("../data/clean-shapefile-ecozone/combine_ecozones_2001.shp", "combine_ecozones_2001") 
```

## Hotspots
```{r}
hotspots = st_read("../data/M6-march-october/M6_mar-oct_2001.shp", "M6_mar-oct_2001") 
```

## Ecozones Polygon
```{r}
ecozones = st_read("../data/ecozones/ne_siberia_ecozones_ee.shp", "ne_siberia_ecozones_ee") 
```

## Arctic Polygon
Cropped ecozones to arctic circle for arctic designation. 

```{r}
eco_arctic = st_read("../data/bbox/ecozone_arctic_crop_ee.shp", "ecozone_arctic_crop_ee") 
```

# Convert to Equal Area

```{r}
fires_ee = st_transform(fires, ee_russia)
hotspots_ee = st_transform(hotspots, ee_russia)
ecozones_ee = st_transform(ecozones, ee_russia)
eco_arctic_ee = st_transform(eco_arctic, ee_russia)
```


# Create attributes
- ID based on row number
- area in meters squared, area_m
- area in Hectares, area_ha
- Year of the burn, fire_yr
- Removed fires less than 400 ha
- Ecozone
- Arctic/subarctic

## Add Area Attributes
```{r}
fires_at = fires_ee %>%
  dplyr::mutate(ID_obj = row_number()) %>% 
  dplyr::mutate(area_m = as.numeric(round(st_area(fires_ee),1))) %>% 
  dplyr::mutate(area_ha = as.numeric(round(area_m*0.0001, 1))) %>% 
  dplyr::mutate(fire_yr = 2001) 
```

%>%
  filter(area_ha >= 400)
```{r}
head(fires_at)
```





```{r}
plot(st_geometry(ecozones_ee), col = sf.colors(12, categorical = TRUE), border = 'grey', 
     axes = TRUE)
plot(st_geometry(st_centroid(fires_at)), pch = 3, col = 'red', add = TRUE)
```

## Add Ecozone attributes

```{r}
fires_at_eco = st_join(fires_at, ecozones_ee) %>% dplyr::select(FID:AREA, ECO_NAME:ECO_SYM, eco_code:geometry) %>% drop_na(eco_code)
```

```{r}
fires_at_eco
```

```{r}
plot(st_geometry(ecozones_ee), border = 'grey', 
     axes = TRUE)
plot(st_geometry(st_centroid(fires_at_eco)), pch = 3, col = 'red', add = TRUE)
```

## Add Arctic/Subarctic Location
```{r}
fires_at_eco_arc = st_join(fires_at_eco, eco_arctic_ee) 
```

```{r}
str(fires_at_eco_arc)
```

### Convert NA to subarctic
For location, arctic and subarctic, we need to redefine the NA values as subartic
```{r}
fires_at_eco_arc$location <- factor(fires_at_eco_arc$location, exclude = NULL, 
               levels = c("arctic", NA), 
               labels = c("arctic", "subarctic"))
fires_at_eco_arc
```

```{r}
plot(st_geometry(ecozones_ee), border = 'grey', 
     axes = TRUE)
plot(st_geometry(st_centroid(fires_at_eco_arc)), pch = 3, col = 'red', add = TRUE)
```

## Add Hotspot attributes

### Function to summarize hotspot attributes
```{r}
sum_pt_poly = function(x){
  x %>% mutate(julian_date = yday(ACQ_DATE)) %>%
  separate(ACQ_DATE, c("acq_year","acq_month", "acq_day"), sep = "-", remove=FALSE) %>% group_by(ID_obj) %>% 
  summarize(min_julian_date = min(julian_date),
            max_julian_date = max(julian_date),
            mean_julian_date = mean(julian_date),
            median_julian_date = median(julian_date),
            min_acq_month = min(acq_month),
            min_acq_day = min(acq_day), 
            max_acq_month = max(acq_month),
            max_acq_day = max(acq_day), 
            min_confidence = min(CONFIDENCE), 
            max_confidence = max(CONFIDENCE), 
            mean_confidence = mean(CONFIDENCE), 
            median_confidence = median(CONFIDENCE)) -> x
  return(x)
}
```


### Apply functions

```{r}
fires_at_eco_arc
```

```{r}
fires_at_eco_arc_hs = st_intersection(hotspots_ee, fires_at_eco_arc) %>% sum_pt_poly()

```

```{r}
fires_at_eco_arc_hs
```
```{r}
plot(st_geometry(ecozones_ee), border = 'grey', 
     axes = TRUE)
plot(st_geometry(st_centroid(fires_at_eco_arc_hs)), pch = 3, col = 'red', add = TRUE)
```

# Write to shapefile

```{r eval=FALSE, include=FALSE}
st_write(all_shp_at, "../outputs/clean-shapefile-ecozone/test2001.shp", driver="ESRI Shapefile") 

```