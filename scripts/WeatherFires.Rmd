---
title: "WeatherFires"
author: "Anna Talucci"
date: "6/8/2021"
output: html_document
---

# Clear workspace

```{r}
rm(list=ls()) 
```


# Overview
[Terra Climate](https://developers.google.com/earth-engine/datasets/catalog/IDAHO_EPSCOR_TERRACLIMATE#bands)

# Library
```{r include=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(broom)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(magrittr)
library(rcompanion)
library(qpcR)
library(tibble)
```

# Define graph Theme and color Palette 

##Themes
```{r}
lb_theme = theme_bw() + theme(legend.position = "bottom") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```

### No Legend
```{r}
bar_theme = theme_bw() + 
  theme(legend.position = "none", legend.title = element_blank()) +
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) 
```

```{r}
bar2_theme = theme_bw() + 
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) 
```


## Palettes
```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
ecoPalette <- c("#CB453D", "#44CB30", "#2E41C3", "#36A4B4", "#B83491", "#B09C32", "#AE3D5F", "#2DC086", "#3261A1")
```




# Data 

## Ecozone
```{r}
ew = read.csv("../data/CombineWeatherEco/MeanMonth2001-2020.csv") 
```

```{r}
ew %>% filter(EcoCode == "CPT") %>%
  filter(FireYr == 2014)
```
```{r}
unique(ew$EcoId)
```
## Fires
```{r}
dfw = read.csv("../data/CombineWeather/MeanMonth2001-2020.csv") 
```

```{r}
dfw
```

## Remove  SSFS Ecozone
```{r}
dfw1 = dfw %>% 
  filter(EcoCode != "SSFS") 
  
```


```{r}
dfw %>% 
  filter(EcoCode == "NSCT") 
```

# Summarise Fire data by Year

## area burned
```{r}

df_Mha = dfw1 %>%
  group_by(EcoCode, FireYr, IDobj) %>%
  summarize(fireHa = min(SIZEha)) %>%
  group_by(EcoCode, FireYr) %>%
  summarize(MHa = (sum(fireHa)))

df_Mha
```


## DEF

```{r}
df_def = dfw1 %>% 
  filter(month %in% 1:9) %>%
  group_by(EcoCode, FireYr, IDobj) %>%
  summarize(fireTotDef = sum(def)) %>%
  drop_na(.) %>%
  ungroup(.) %>%
    group_by(EcoCode, FireYr) %>%
  summarise(FireMeanDef = mean(fireTotDef))


df_def
```

## TMMX

```{r}
df_tmmx = dfw1 %>% 
  filter(month %in% 6:8) %>%
  group_by(EcoCode, FireYr, IDobj) %>%
  summarize(fireMeanTmmx = mean(tmmx)) %>%
  drop_na(.) %>%
  ungroup(.) %>%
    group_by(EcoCode, FireYr) %>%
  summarise(FireMeanTmmx = mean(fireMeanTmmx))


df_tmmx
```

## Precip

```{r}
df_pr = dfw1 %>% 
  filter(month %in% 1:9) %>%
  group_by(EcoCode, FireYr, IDobj) %>%
  summarize(fireTotPr = sum(pr)) %>%
  drop_na(.) %>%
  ungroup %>%
    group_by(EcoCode, FireYr) %>%
  summarise(FireMeanPr = mean(fireTotPr))


df_pr
```

## Combine Data
```{r}
fires = df_Mha %>% 
  left_join(df_def) %>%
  left_join(df_tmmx) %>%
  left_join(df_pr)

fires
```

# Summarise Ecozone data by Year

## DEF

```{r}
eco_def = ew %>% 
  filter(month %in% 1:9) %>%
  drop_na(.) %>%
  group_by(EcoCode, FireYr, EcoId) %>%
  summarize(fireTotDef = sum(def)) %>%
  drop_na(.) %>%
    group_by(EcoCode, FireYr) %>%
  summarise(EcoMeanDef = mean(fireTotDef))


eco_def
```

## TMMX


```{r}
eco_tmmx = ew %>% 
  filter(month %in% 6:8) %>%
  drop_na(.) %>%
  group_by(EcoCode, FireYr, month) %>%
  summarize(mean_montmmx = mean(tmmx)) %>%
  ungroup(.) %>%
  group_by(EcoCode, FireYr) %>%
  summarize(EcoMeanTmmx = mean(mean_montmmx))


eco_tmmx
```
%>%
  drop_na(.) %>%
    group_by(EcoCode, FireYr) %>%
  summarise(AvgDef = mean(fireTotDef))
## Precip

```{r}
eco_pr = ew %>% 
  filter(month %in% 1:9) %>%
  drop_na(.) %>%
  group_by(EcoCode, FireYr, EcoId) %>%
  summarize(accumPr = sum(pr)) %>%
  ungroup(.) %>%
    group_by(EcoCode, FireYr) %>%
  summarise(EcoMeanTotPr = mean(accumPr))


eco_pr
```

## Combine Data
```{r}
ew1 = eco_pr %>% 
  left_join(eco_def) %>%
  left_join(eco_tmmx)

ew1
```

# COmbine summarized data
For ecozones that have years with no fire, we will use the climate values summarized by ecozone. So here we combine fire summarized data with ecozone summarized data, repalce NA with 0 for MHa. Than filter only years with 0 MHa burned.
```{r}
mha_0 = ew1 %>%
  left_join(fires) %>%
  dplyr::mutate(MHa = replace_na(MHa, 0)) %>%
  filter(MHa == 0)  %>%
  mutate(FireMeanDef = EcoMeanDef) %>%
  mutate(FireMeanTmmx = EcoMeanTmmx) %>%
  mutate(FireMeanPr = EcoMeanTotPr) %>%
  dplyr::select(EcoCode, FireYr, MHa, FireMeanDef, FireMeanTmmx, FireMeanPr)

mha_0 
```

```{r}
ew1

```
```{r}
rows_na = ew1 %>% 
  left_join(fires) %>%
  dplyr::mutate(MHa = replace_na(MHa, 0)) %>%
  filter(MHa != 0)  %>%
  filter_all(any_vars(is.na(.))) %>%
  mutate(FireMeanDef = EcoMeanDef) %>%
  mutate(FireMeanTmmx = EcoMeanTmmx) %>%
  mutate(FireMeanPr = EcoMeanTotPr) %>%
  dplyr::select(EcoCode, FireYr, MHa, FireMeanDef, FireMeanTmmx, FireMeanPr)


rows_na
```

```{r}
mhanot0 = ew1 %>% 
  left_join(fires) %>%
  dplyr::mutate(MHa = replace_na(MHa, 0)) %>%
  filter(MHa != 0)  %>%
  drop_na(.) %>%
  dplyr::select(EcoCode, FireYr, MHa, FireMeanDef, FireMeanTmmx, FireMeanPr)


mhanot0
```

```{r}

data1 = bind_rows(mha_0, mhanot0, rows_na) %>%
  mutate(log_Mha = log(MHa + 0.1 )) %>%
  mutate(log_def = log(FireMeanDef))

data1
```

# Visualize

```{r fig.height=7, fig.width=6}
ggplot(data = data1, aes(x = FireMeanDef, y = MHa, color = EcoCode)) + 
  geom_smooth(method="lm", se=TRUE, alpha=0.1) +
  geom_point(size = 1) +
  scale_color_manual(values=cbbPalette) +
  facet_wrap(~EcoCode, scales = "free", ncol=2 ) +
  theme_bw() +
  theme(strip.background = element_rect(color=NA, fill="white", size=1.5, linetype="solid")) 

```





```{r fig.height=7, fig.width=6}
ggplot(data = data1, aes(x = FireMeanTmmx, y = MHa, color = EcoCode)) + 
  geom_smooth(method="lm", se=TRUE, alpha=0.1) +
  geom_point(size = 1) +
  scale_color_manual(values=cbbPalette) +
  facet_wrap(~EcoCode, scales = "free", ncol=2 ) +
  theme_bw() +
  theme(strip.background = element_rect(color=NA, fill="white", size=1.5, linetype="solid")) 

```



```{r fig.height=7, fig.width=6}
ggplot(data = data1, aes(x = FireMeanPr, y = MHa, color = EcoCode)) + 
  geom_smooth(method="lm", se=TRUE, alpha=0.1) +
  geom_point(size = 1) +
  scale_color_manual(values=cbbPalette) +
  facet_wrap(~EcoCode, scales = "free", ncol=2 ) +
  theme_bw() +
  theme(strip.background = element_rect(color=NA, fill="white", size=1.5, linetype="solid")) 

```


# Analysis
## Model Climate Moisture Deficit
```{r}
fit1 = lm(log_Mha ~ log_def + EcoCode + log_def:EcoCode, data = data1)
```
#### Residuals


```{r}
# Get the fitted value for each observation
data1$fit1 = fitted(fit1)
```

```{r}
# Get the residuals of the model
data1$res1 = residuals(fit1)
```

```{r}
qplot(x = fit1, y = res1, data = data1,
main = "Residuals vs Fitted Values")
```

```{r}
qplot(x = FireMeanDef, y = res1, data = data1,
xlab = "CMD",
ylab = "Residuals",
main = "Residuals vs CMD")
```
```{r}
qplot(x = factor(1), y = res1, data = data1, geom = "boxplot")
```

```{r}
qqnorm(data1$res1, main = "Normal QQ Plot of Residuals")
qqline(data1$res1) # add reference line to the qq plot
```

```{r}
plot(fit1, which = 1) # residual vs fitted values
```

```{r}
plot(fit1, which = 2) # qqnorm plot of residuals
```

### Summary
```{r}
summary(fit1)
```
```{r}
summary(fit1)$r.squared 
```
```{r}
int_BT = coef(fit1)[1]
int_CKMT = coef(fit1)[1] + coef(fit1)[3]
int_CPT = coef(fit1)[1] + coef(fit1)[4]
int_EST = coef(fit1)[1] + coef(fit1)[5]
int_NSCT = coef(fit1)[1] + coef(fit1)[6]
int_NST = coef(fit1)[1] + coef(fit1)[7]
int_TBBMT = coef(fit1)[1] + coef(fit1)[8]
int_TCST = coef(fit1)[1] + coef(fit1)[9]

int_BT
int_CKMT
int_CPT
int_EST
int_NSCT
int_NST
int_TBBMT
int_TCST

slope_BT = coef(fit1)[2]
slope_CKMT = coef(fit1)[2] + coef(fit1)[10]
slope_CPT = coef(fit1)[2] + coef(fit1)[11]
slope_EST = coef(fit1)[2] + coef(fit1)[12]
slope_NSCT = coef(fit1)[2] + coef(fit1)[13]
slope_NST = coef(fit1)[2] + coef(fit1)[14]
slope_TBBMT = coef(fit1)[2] + coef(fit1)[15]
slope_TCST = coef(fit1)[2] + coef(fit1)[16]

slope_BT
slope_CKMT
slope_CPT
slope_EST
slope_NSCT
slope_NST
slope_TBBMT
slope_TCST

```


### Pulling out r-squared for each group
reference: https://drsimonj.svbtle.com/running-a-model-on-separate-groups

lm(formula = biomass_log ~ ndvi + res_meters + ndvi:res_meters, 
    data = field_ndvi_long1
```{r}
 data1 %>% 
  nest(-EcoCode) %>% 
  mutate(fit = map(data, ~ lm(MHa ~ FireMeanDef, data = .)),
         results = map(fit, glance)) %>% 
  unnest(results)
```

```{r}
data1 %>% 
  nest(-EcoCode) %>% 
  mutate(fit = map(data, ~ lm(MHa ~ FireMeanDef, data = .)),
         results = map(fit, glance)) %>% 
  unnest(results) %>% 
  ggplot(aes(x = factor(EcoCode), y = r.squared)) +
    geom_bar(stat = "identity") +
    labs(x = "Climate Moisture Deficit", y = expression(R^{2}))
```


### Plot

```{r fig.height=5, fig.width=6}
plot_fit1 = ggplot(data = data1, aes(x = log_def, y = log_Mha, color = EcoCode)) + 
  geom_smooth(method="lm", se=TRUE, alpha=0.1) +
  geom_point(size = 1) +
  scale_color_manual(values=cbbPalette) +
    labs(y=expression(atop("Log-transformed Mha")), x= "Climate Moisture Deficit", color = "Buffer resolution") +
  theme_bw() + 
  theme(legend.position = "bottom") +
  guides(colour = guide_legend(nrow = 1))

plot_fit1
  
```


```{r fig.height=7, fig.width=6}
ggplot(data = dfw2, aes(x = tot_def, y = log_Mha, color = EcoCode)) + 
  geom_smooth(method="lm", se=TRUE, alpha=0.1) +
  geom_point(size = 1) +
  scale_color_manual(values=cbbPalette) +
  facet_wrap(~EcoCode, scales = "free", ncol=2 ) +
  theme_bw() +
  theme(strip.background = element_rect(color=NA, fill="white", size=1.5, linetype="solid")) 

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-08-19_ndvi-biomass-resolution.jpeg", plot = plot_fit1, width = 6, height = 5, units = c("in"), dpi=600 )
```


## Model Precip


**THE END**